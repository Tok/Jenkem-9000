<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ImagePreparer.scala</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jenkem</a> &gt; <a href="index.html" class="el_package">jenkem.ui</a> &gt; <span class="el_source">ImagePreparer.scala</span></div><h1>ImagePreparer.scala</h1><pre class="source lang-java linenums">/*
 * #%L
 * ImagePreparer.scala - Jenkem - Tok - 2012
 * %%
 * Copyright (C) 2012 - 2013 Lukas Steiger &lt;lsteiger4@gmail.com&gt;
 * %%
 * This program is free software. It comes without any warranty, to
 * the extent permitted by applicable law. You can redistribute it
 * and/or modify it under the terms of the Do What The Fuck You Want
 * To Public License, Version 2, as published by Sam Hocevar.
 * See http://www.wtfpl.net/ for more details.
 * #L%
 */
package jenkem.ui

import java.awt.image.BufferedImage
import java.net.URL
import com.vaadin.annotations.JavaScript
import com.vaadin.event.EventRouter
import com.vaadin.event.FieldEvents.FocusEvent
import com.vaadin.event.FieldEvents.FocusListener
import com.vaadin.server.Page
import com.vaadin.server.UserError
import com.vaadin.ui.Alignment
import com.vaadin.ui.Button
import com.vaadin.ui.Button.ClickEvent
import com.vaadin.ui.GridLayout
import com.vaadin.ui.HorizontalLayout
import com.vaadin.ui.Label
import com.vaadin.ui.TextField
import jenkem.event.DoConversionEvent
import jenkem.js.Cropper
import jenkem.js.CropperChangeListener
import jenkem.js.Crops
import jenkem.util.UrlOptionizer
import com.vaadin.ui.Slider
import com.vaadin.ui.Layout
import com.vaadin.data.Property
import com.vaadin.data.Property.ValueChangeEvent
import com.vaadin.ui.Component
import com.vaadin.ui.AbstractOrderedLayout

<span class="fc" id="L43">class ImagePreparer(val eventRouter: EventRouter) extends GridLayout {</span>
<span class="fc" id="L44">  val captionWidth = &quot;100px&quot;</span>

<span class="fc" id="L46">  var disableTrigger = false</span>
<span class="fc" id="L47">  var crops = new Crops(0, 0, 100, 100, 100, 100)</span>
<span class="fc" id="L48">  val cropper = new Cropper</span>
<span class="fc" id="L49">  cropper.setWidth(&quot;100px&quot;)</span>
<span class="fc" id="L50">  cropper.setHeight(&quot;150px&quot;)</span>

<span class="pc bpc" id="L52" title="1 of 2 branches missed.">  cropper.addListener(new CropperChangeListener {</span>
    override def valueChange(c: Crops) {
<span class="fc" id="L54">      crops = c</span>
<span class="fc" id="L55">      val cropText = &quot;Top: -&quot; + crops.y + &quot;% Bottom: -&quot; + (100 - crops.y2) +</span>
<span class="fc" id="L56">              &quot;% Left: -&quot; + crops.x + &quot;% Right: -&quot; + (100 - crops.x2) + &quot;%&quot;</span>
<span class="fc" id="L57">      cropLabel.setValue(cropText)</span>
<span class="fc" id="L58">      trigger</span>
    }
  })

<span class="fc" id="L62">  val statusLayout = new HorizontalLayout</span>
<span class="fc" id="L63">  val statusCaptionLabel = new Label(&quot;Status: &quot;)</span>
<span class="fc" id="L64">  statusCaptionLabel.setWidth(captionWidth)</span>
<span class="fc" id="L65">  val statusLabel = new Label(&quot;Ready...&quot;)</span>
<span class="fc" id="L66">  statusLayout.setSpacing(true)</span>
<span class="fc" id="L67">  addToLayoutLeft(statusLayout, statusCaptionLabel)</span>
<span class="fc" id="L68">  addToLayoutLeft(statusLayout, statusLabel)</span>

<span class="fc" id="L70">  val urlLayout = new HorizontalLayout</span>
<span class="fc" id="L71">  val urlCaptionLabel = new Label(&quot;Image URL: &quot;)</span>
<span class="fc" id="L72">  urlCaptionLabel.setWidth(captionWidth)</span>
<span class="fc" id="L73">  val inputTextField = new TextField</span>
<span class="fc" id="L74">  inputTextField.setWidth(&quot;570px&quot;)</span>
<span class="fc" id="L75">  inputTextField.focus</span>
<span class="fc" id="L76">  inputTextField.setImmediate(true)</span>
<span class="fc" id="L77">  val convButton = new Button(&quot;Convert Image&quot;)</span>
<span class="fc" id="L78">  urlLayout.setSpacing(true)</span>
<span class="fc" id="L79">  addToLayoutLeft(urlLayout, urlCaptionLabel)</span>
<span class="fc" id="L80">  addToLayoutLeft(urlLayout, inputTextField)</span>
<span class="fc" id="L81">  addToLayoutLeft(urlLayout, convButton)</span>

<span class="fc" id="L83">  val submissionLayout = new HorizontalLayout</span>
<span class="fc" id="L84">  val submissionCaptionLabel = new Label(&quot;Name: &quot;)</span>
<span class="fc" id="L85">  submissionCaptionLabel.setWidth(captionWidth)</span>
<span class="fc" id="L86">  val submitter = new Submitter(eventRouter)</span>
<span class="fc" id="L87">  submissionLayout.setSpacing(true)</span>
<span class="fc" id="L88">  addToLayoutLeft(submissionLayout, submissionCaptionLabel)</span>
<span class="fc" id="L89">  addToLayoutLeft(submissionLayout, submitter)</span>
<span class="fc" id="L90">  val resetAllButton = new Button(&quot;Reset All&quot;)</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">  resetAllButton.addClickListener(new Button.ClickListener {</span>
    override def buttonClick(event: ClickEvent) {
<span class="fc" id="L93">      disableTrigger = true</span>
<span class="fc" id="L94">      submitter.reset</span>
<span class="fc" id="L95">      brightnessSlider.setValue(0)</span>
<span class="fc" id="L96">      contrastSlider.setValue(0)</span>
<span class="fc" id="L97">      disableTrigger = false</span>
<span class="fc" id="L98">      cropper.setImageSrc(cropper.getImageSrc)</span>
    }
  })
<span class="fc" id="L101">  addToLayoutLeft(submissionLayout, resetAllButton)</span>

<span class="fc" id="L103">  val brightnessLayout = new HorizontalLayout</span>
<span class="fc" id="L104">  brightnessLayout.setSpacing(true)</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">  val (brightnessSlider, brightnessLabel) = makeSliderAndLabel(&quot;Brightness: &quot;, -100, 100, 0, brightnessLayout)</span>

<span class="fc" id="L107">  val contrastLayout = new HorizontalLayout</span>
<span class="fc" id="L108">  contrastLayout.setSpacing(true)</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">  val (contrastSlider, contrastLabel) = makeSliderAndLabel(&quot;Contrast: &quot;, -70, 70, 0, contrastLayout)</span>

<span class="fc" id="L111">  val cropLayout = new HorizontalLayout</span>
<span class="fc" id="L112">  val cropCaptionLabel = new Label(&quot;Cropping: &quot;)</span>
<span class="fc" id="L113">  cropCaptionLabel.setWidth(captionWidth)</span>
<span class="fc" id="L114">  cropLayout.setSpacing(true)</span>
<span class="fc" id="L115">  addToLayoutLeft(cropLayout, cropCaptionLabel)</span>
<span class="fc" id="L116">  val resetButton = new Button(&quot;Select All&quot;)</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">  resetButton.addClickListener(new Button.ClickListener {</span>
    override def buttonClick(event: ClickEvent) {
<span class="fc" id="L119">      cropper.setImageSrc(cropper.getImageSrc)</span>
    }
  })
<span class="fc" id="L122">  addToLayoutLeft(cropLayout, resetButton)</span>
<span class="fc" id="L123">  val cropLabel = new Label</span>
<span class="fc" id="L124">  addToLayoutLeft(cropLayout, cropLabel)</span>

<span class="fc" id="L126">  bind</span>

<span class="fc" id="L128">  setSpacing(true)</span>
<span class="fc" id="L129">  setMargin(true)</span>
  //   0   1
  //0 ### [Status]
  //1 ### [Url   ]
  //2 ### [Bright]
  //3 ### [Cont  ]
  //4 ### [Sub   ]
  //5 ### [Crop  ]
<span class="fc" id="L137">  setRows(6)</span>
<span class="fc" id="L138">  setColumns(2)</span>

<span class="fc" id="L140">  addComponent(cropper, 0, 0, 0, 5)</span>
<span class="fc" id="L141">  setComponentAlignment(cropper, Alignment.TOP_LEFT)</span>
<span class="fc" id="L142">  addMiddleLeft(statusLayout, 1, 0)</span>
<span class="fc" id="L143">  addMiddleLeft(urlLayout, 1, 1)</span>
<span class="fc" id="L144">  addMiddleLeft(brightnessLayout, 1, 2)</span>
<span class="fc" id="L145">  addMiddleLeft(contrastLayout, 1, 3)</span>
<span class="fc" id="L146">  addMiddleLeft(submissionLayout, 1, 4)</span>
<span class="fc" id="L147">  addMiddleLeft(cropLayout, 1, 5)</span>

  private def addMiddleLeft(comp: Component, col: Int, row: Int): Unit = {
<span class="fc" id="L150">    addComponent(comp, col, row)</span>
<span class="fc" id="L151">    setComponentAlignment(comp, Alignment.MIDDLE_LEFT)</span>
  }

  private def addToLayoutLeft(layout: AbstractOrderedLayout, comp: Component): Unit = {
<span class="fc" id="L155">    layout.addComponent(comp)</span>
<span class="fc" id="L156">    layout.setComponentAlignment(comp, Alignment.MIDDLE_LEFT)</span>
  }

  private def makeSliderAndLabel(caption: String, min: Int, max: Int, default: Int, layout: HorizontalLayout): (Slider, Label) = {
<span class="fc" id="L160">    val label = new Label(default.toString)</span>
<span class="fc" id="L161">    label.setWidth(&quot;30px&quot;)</span>
<span class="fc" id="L162">    label.setStyleName(&quot;sliderLabel&quot;)</span>
<span class="fc" id="L163">    val slider = new Slider(None.orNull)</span>
<span class="fc" id="L164">    slider.setWidth(&quot;570px&quot;)</span>
<span class="fc" id="L165">    slider.setMin(min)</span>
<span class="fc" id="L166">    slider.setMax(max)</span>
<span class="fc" id="L167">    slider.setValue(default)</span>
<span class="fc" id="L168">    slider.setImmediate(true)</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">    slider.addValueChangeListener(new Property.ValueChangeListener {</span>
      override def valueChange(event: ValueChangeEvent): Unit = {
<span class="fc" id="L171">        label.setValue(&quot;%1.0f&quot;.format(event.getProperty.getValue))</span>
<span class="fc" id="L172">        trigger</span>
      }
    })
<span class="fc" id="L175">    val button = new Button(&quot;Reset&quot;)</span>
<span class="fc" id="L176">    button.addClickListener(new Button.ClickListener {</span>
      override def buttonClick(event: ClickEvent) {
<span class="nc" id="L178">        slider.setValue(default)</span>
      }
    })
<span class="fc" id="L181">    val captionLabel = new Label(caption)</span>
<span class="fc" id="L182">    captionLabel.setWidth(captionWidth)</span>
<span class="fc" id="L183">    addToLayoutLeft(layout, captionLabel)</span>
<span class="fc" id="L184">    addToLayoutLeft(layout, slider)</span>
<span class="fc" id="L185">    addToLayoutLeft(layout, label)</span>
<span class="fc" id="L186">    addToLayoutLeft(layout, button)</span>
<span class="fc" id="L187">    (slider, label)</span>
  }

<span class="fc" id="L190">  def getBrightness(): Int = brightnessLabel.getValue.toInt</span>
<span class="fc" id="L191">  def getContrast(): Int = contrastLabel.getValue.toInt</span>

  private def bind(): Unit = {
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">    inputTextField.addFocusListener(new FocusListener {</span>
<span class="fc" id="L195">      override def focus(event: FocusEvent): Unit = inputTextField.selectAll</span>
    })
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">    convButton.addClickListener(new Button.ClickListener {</span>
<span class="nc" id="L198">      override def buttonClick(event: ClickEvent): Unit = replaceUrl</span>
    })
  }
<span class="fc" id="L201">  private def replaceImage(url: URL): Unit = cropper.setImageSrc(url.toString)</span>
  private def trigger(): Unit = {
<span class="fc bfc" id="L203" title="All 4 branches covered.">    if (!disableTrigger) {</span>
<span class="fc" id="L204">      eventRouter.fireEvent(new DoConversionEvent(true, true))</span>
    }
  }
  private def updateLabel(status: String, error: String): Unit = {
<span class="pc" id="L208">    Option(error) match {</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">      case Some(error) =&gt; statusLabel.setComponentError(new UserError(error))</span>
<span class="pc bpc" id="L210" title="4 of 6 branches missed.">      case None =&gt; statusLabel.setComponentError(None.orNull)</span>
    }
<span class="fc" id="L212">    statusLabel.setValue(status)</span>
  }
<span class="fc" id="L214">  def setStatus(status: String): Unit = updateLabel(status, None.orNull)</span>
<span class="fc" id="L215">  def setError(error: String): Unit = updateLabel(error, error)</span>
<span class="fc" id="L216">  def addIcon(img: BufferedImage): Unit = submitter.addIcon(img)</span>
<span class="fc" id="L217">  def setName(name: String): Unit = submitter.setName(name)</span>
<span class="fc" id="L218">  def getName: String = submitter.getName</span>
<span class="fc" id="L219">  def isInvert: Boolean = submitter.isInvert</span>
<span class="fc" id="L220">  def getBg: String = submitter.getBg</span>
<span class="fc" id="L221">  def enableSubmission(enabled: Boolean): Unit = submitter.enableSubmission(enabled)</span>
<span class="fc" id="L222">  def getCrops: (Int, Int, Int, Int) = (crops.x, crops.x2, crops.y, crops.y2)</span>
  def hasLink: Boolean = {
<span class="pc" id="L224">    Option(inputTextField.getValue) match {</span>
<span class="pc bpc" id="L225" title="1 of 4 branches missed.">      case Some(value) =&gt; !value.equals(&quot;&quot;)</span>
<span class="nc bnc" id="L226" title="All 6 branches missed.">      case None =&gt; false</span>
    }
  }
<span class="fc" id="L229">  def setLink(link: String): Unit = {</span>
<span class="fc" id="L230">    inputTextField.setValue(link)</span>
<span class="pc" id="L231">    UrlOptionizer.extract(link) match {</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">      case Some(u) =&gt;</span>
<span class="nc" id="L233">        replaceImage(u)</span>
<span class="nc" id="L234">        Page.getCurrent.setUriFragment(&quot;main/&quot; + link)</span>
<span class="pc bpc" id="L235" title="4 of 6 branches missed.">      case None =&gt; setError(&quot;URL is not Valid. Please enter URL to an image: &quot;)</span>
    }
  }
<span class="nc" id="L238">  private def replaceUrl(): Unit = {</span>
<span class="nc" id="L239">    val currentFrag = Page.getCurrent.getUriFragment</span>
<span class="nc" id="L240">    val currentUrl = inputTextField.getValue</span>
<span class="nc" id="L241">    Option(currentFrag) match {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">      case Some(frag) =&gt;</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">        if (!currentFrag.endsWith(currentUrl)) {</span>
<span class="nc" id="L244">          UrlOptionizer.extract(currentUrl) match {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            case Some(u) =&gt;</span>
<span class="nc" id="L246">              Page.getCurrent.setUriFragment(&quot;main/&quot; + currentUrl)</span>
<span class="nc" id="L247">              replaceImage(u)</span>
<span class="nc bnc" id="L248" title="All 6 branches missed.">            case None =&gt; setError(&quot;URL is not Valid. Please enter URL to an image: &quot;)</span>
          }
<span class="nc" id="L250">        } else { trigger }</span>
<span class="nc bnc" id="L251" title="All 6 branches missed.">      case None =&gt; { trigger }</span>
    }
  }
  def getUrl: Option[String] = {
<span class="pc" id="L255">    UrlOptionizer.extract(inputTextField.getValue) match {</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">      case Some(u) =&gt; Option(u.toString)</span>
<span class="pc bpc" id="L257" title="4 of 6 branches missed.">      case None =&gt; None</span>
    }
  }
<span class="fc" id="L260">  def reset: Unit = submitter.reset</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.20130617-1803</span></div></body></html>